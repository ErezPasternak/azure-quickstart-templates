{
   "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "dnsLabelPrefix":{
         "type":"string",
         "metadata":{
            "description":"Unique public DNS prefix for the deployment. The fqdn will look something like '<dnsname>.westus.cloudapp.azure.com'. Up to 62 chars, digits or dashes, lowercase, should start with a letter: must conform to '^[a-z][a-z0-9-]{1,61}[a-z0-9]$'."
         }
      },
      "siteLocation":{
         "type":"string",
         "defaultValue":"West US",
         "allowedValues":[
            "West US",
            "East US",
            "East US 2",
            "Central US",
            "South Central US",
            "North Central US",
            "North Europe",
            "West Europe",
            "East Asia",
            "Southeast Asia",
            "Japan East",
            "Japan West",
            "Brazil South",
            "Australia East",
            "Australia Southeast",
            "Central India",
            "South India",
            "West India"
         ],
         "metadata":{
            "description":"Location to deploy to"
         }
      },
      "emailAddress":{
         "type":"string",
         "defaultValue":"Erez.Pasternak@ericom.com",
         "metadata":{
            "description":"The email address to send the test message to."
         }
      }
   },
   "variables":{
      "storageAccountName":"[concat(uniquestring(resourceGroup().id), 'RDS', 'Storage')]",
      "domainName":"esb.local",
      "adminUsername":"ericom",
      "adminPassword":"Ericom123$",
      "tenantInfo" : "root",
      "numberOfRdshInstances":1,
      "numberOflnxInstances":1,
      "rdshVmSize":"Standard_D2",
      "LinuxVmSize" : "Standard_D2",
      "imagePublisherWindows":"MicrosoftWindowsServer",
      "imagePublisherLinux":"Canonical",
      "imageOfferWindows":"WindowsServer",
      "imageOfferLinux":"UbuntuServer",
      "imageSKUWindows":"2012-R2-Datacenter",
      "imageSKULinux":"14.04.2-LTS",
      "vnetAddressRange":"10.0.0.0/16",
      "subnetAddressRange":"10.0.0.0/24",
      "dnsServerPrivateIp":"10.0.0.8",
      "subnetName":"Subnet",
      "subnet-id":"[concat(resourceId('Microsoft.Network/virtualNetworks','VNET'),'/subnets/',variables('subnetName'))]",
      "customScriptLocation":"https://raw.githubusercontent.com/ErezPasternak/azure-quickstart-templates/EricomConnect/SecureBrowsing/",
      "publicIpRef":"publicIp",
      "ecGridname":"ecgrid",
      "sqlserver":"localhost",
      "sqldatabase":"ERICOMCONNECTDB",
      "sqluser":"sa",
      "sqlpassword":"P@55w0rd",
      "apiVersion":"2015-06-15",
      "command":"[concat('bash install_ericom.sh ', variables('domainName'),' ', variables('adminUsername'),' ', variables('adminPassword'),' broker.',variables('domainName'),' ', variables('tenantInfo'))]"
   },
   "resources":[
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/publicIPAddresses",
         "name":"[variables('publicIpRef')]",
         "location":"[parameters('siteLocation')]",
         "properties":{
            "publicIPAllocationMethod":"Dynamic",
            "dnsSettings":{
               "domainNameLabel":"[parameters('dnsLabelPrefix')]"
            }
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Storage/storageAccounts",
         "name":"[variables('StorageAccountName')]",
         "location":"[parameters('siteLocation')]",
         "properties":{
            "accountType":"Standard_LRS"
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Compute/availabilitySets",
         "name":"availabilityset",
         "location":"[parameters('siteLocation')]"
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/virtualNetworks",
         "name":"vnet",
         "location":"[parameters('siteLocation')]",
         "properties":{
            "addressSpace":{
               "addressPrefixes":[
                  "[variables('vnetAddressRange')]"
               ]
            },
            "subnets":[
               {
                  "name":"[variables('subnetName')]",
                  "properties":{
                     "addressPrefix":"[variables('subnetAddressRange')]"
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/loadBalancers",
         "name":"loadBalancer",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "[concat('Microsoft.Network/publicIPAddresses/',variables('publicIpRef'))]"
         ],
         "properties":{
            "frontendIPConfigurations":[
               {
                  "name":"LBFE",
                  "properties":{
                     "publicIPAddress":{
                        "id":"[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIpRef'))]"
                     }
                  }
               }
            ],
            "backendAddressPools":[
               {
                  "name":"LBBAP"
               }
            ],
            "inboundNatRules":[
               {
                  "name":"https",
                  "properties":{
                     "frontendIPConfiguration":{
                        "id":"[concat(resourceId('Microsoft.Network/loadBalancers','loadBalancer'),'/frontendIPConfigurations/LBFE')]"
                     },
                     "protocol":"tcp",
                     "frontendPort":443,
                     "backendPort":443,
                     "enableFloatingIP":false
                  }
               },
               {
                  "name":"gateway",
                  "properties":{
                     "frontendIPConfiguration":{
                        "id":"[concat(resourceId('Microsoft.Network/loadBalancers','loadBalancer'),'/frontendIPConfigurations/LBFE')]"
                     },
                     "protocol":"udp",
                     "frontendPort":3391,
                     "backendPort":3391,
                     "enableFloatingIP":false
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/networkInterfaces",
         "name":"dc-nif",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "Microsoft.Network/virtualNetworks/vnet"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig",
                  "properties":{
                     "privateIPAllocationMethod":"Static",
                     "privateIPAddress":"[variables('dnsServerPrivateIp')]",
                     "subnet":{
                        "id":"[variables('subnet-id')]"
                     }
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Compute/virtualMachines",
         "name":"dc-vm",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "[resourceId('Microsoft.Storage/storageAccounts',variables('StorageAccountName'))]",
            "[resourceId('Microsoft.Network/networkInterfaces','dc-nif')]"
         ],
         "properties":{
            "hardwareProfile":{
               "vmSize":"Standard_D2"
            },
            "osProfile":{
               "computerName":"dc",
               "adminUsername":"[variables('adminUsername')]",
               "adminPassword":"[variables('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"[variables('imagePublisherWindows')]",
                  "offer":"[variables('imageOfferWindows')]",
                  "sku":"[variables('imageSkuWindows')]",
                  "version":"latest"
               },
               "osDisk":{
                  "name":"osdisk",
                  "vhd":{
                     "uri":"[concat('http://',variables('StorageAccountName'),'.blob.core.windows.net/vhds/dc-vm-os-disk.vhd')]"
                  },
                  "caching":"ReadWrite",
                  "createOption":"FromImage"
               },
               "dataDisks":[
                  {
                     "name":"dc-vm-data-disk",
                     "vhd":{
                        "Uri":"[concat('http://',variables('StorageAccountName'),'.blob.core.windows.net/vhds/dc-vm-data-disk.vhd')]"
                     },
                     "caching":"None",
                     "createOption":"Empty",
                     "diskSizeGB":"1000",
                     "lun":0
                  }
               ]
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces','dc-nif')]"
                  }
               ]
            }
         },
         "resources":[
            {
               "type":"Microsoft.Compute/virtualMachines/extensions",
               "name":"dc-vm/createadforest",
               "apiVersion":"[variables('apiVersion')]",
               "location":"[parameters('siteLocation')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Compute/virtualMachines', 'dc-vm')]"
               ],
               "properties":{
                  "publisher":"Microsoft.Powershell",
                  "type":"DSC",
                  "typeHandlerVersion":"2.8",
                  "settings":{
                     "ModulesUrl":"[concat(variables('customScriptLocation'),'CreateADPDC.zip')]",
                     "ConfigurationFunction":"CreateADPDC.ps1\\CreateADPDC",
                     "Properties":{
                        "DomainName":"[variables('domainName')]",
                        "AdminCreds":{
                           "UserName":"[variables('adminUsername')]",
                           "Password":"PrivateSettingsRef:AdminPassword"
                        },
                        "emailAddress":"[parameters('emailAddress')]"
                     }
                  },
                  "protectedSettings":{
                     "Items":{
                        "AdminPassword":"[variables('adminPassword')]"
                     }
                  }
               }
            }
         ]
      },
      {
         "apiVersion":"2015-01-01",
         "type":"Microsoft.Resources/deployments",
         "name":"updatevnetdns",
         "dependsOn":[
            "Microsoft.Compute/virtualMachines/dc-vm/extensions/createadforest"
         ],
         "properties":{
            "mode":"Incremental",
            "templateLink":{
               "uri":"[concat(variables('customScriptLocation'),'vnet-with-dns-server.json')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{
               "virtualNetworkName":{
                  "value":"VNET"
               },
               "virtualNetworkAddressRange":{
                  "value":"[variables('vnetAddressRange')]"
               },
               "subnetName":{
                  "value":"[variables('subnetName')]"
               },
               "subnetRange":{
                  "value":"[variables('subnetAddressRange')]"
               },
               "DNSServerAddress":{
                  "value":[
                     "[variables('dnsServerPrivateIp')]"
                  ]
               }
            }
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/networkInterfaces",
         "name":"gw-nif",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "Microsoft.Network/loadBalancers/loadBalancer",
            "Microsoft.Resources/deployments/updatevnetdns"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[variables('subnet-id')]"
                     },
                     "loadBalancerBackendAddressPools":[
                        {
                           "id":"[concat(resourceId('Microsoft.Network/loadBalancers','loadBalancer'),'/backendAddressPools/LBBAP')]"
                        }
                     ],
                     "loadBalancerInboundNatRules":[
                        {
                           "id":"[concat(resourceId('Microsoft.Network/loadBalancers','loadBalancer'),'/inboundNatRules/https')]"
                        },
                        {
                           "id":"[concat(resourceId('Microsoft.Network/loadBalancers','loadBalancer'),'/inboundNatRules/gateway')]"
                        }
                     ]
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/networkInterfaces",
         "name":"cb-nif",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "Microsoft.Resources/deployments/updatevnetdns"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[variables('subnet-id')]"
                     }
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/networkInterfaces",
         "name":"[concat('lnx-', copyindex(), '-nif')]",
         "location":"[parameters('siteLocation')]",
         "copy":{
            "name":"lnx-nif-loop",
            "count":"[variables('numberOflnxInstances')]"
         },
         "dependsOn":[
            "Microsoft.Resources/deployments/updatevnetdns"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[variables('subnet-id')]"
                     }
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Network/networkInterfaces",
         "name":"[concat('rdsh-', copyindex(), '-nif')]",
         "location":"[parameters('siteLocation')]",
         "copy":{
            "name":"rdsh-nif-loop",
            "count":"[variables('numberOfRdshInstances')]"
         },
         "dependsOn":[
            "Microsoft.Resources/deployments/updatevnetdns"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig",
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[variables('subnet-id')]"
                     }
                  }
               }
            ]
         }
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Compute/virtualMachines",
         "name":"gw-vm",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "[concat('Microsoft.Storage/storageAccounts/', variables('StorageAccountName'))]",
            "[resourceId('Microsoft.Compute/availabilitySets', 'availabilityset')]",
            "Microsoft.Network/networkInterfaces/gw-nif",
            "Microsoft.Compute/virtualMachines/cb-vm/extensions/EricomConnectServerSetup"
         ],
         "properties":{
            "hardwareProfile":{
               "vmSize":"Standard_D2"
            },
            "availabilitySet":{
               "id":"[resourceId('Microsoft.Compute/availabilitySets', 'availabilityset')]"
            },
            "osProfile":{
               "computerName":"gateway",
               "adminUsername":"[variables('adminUsername')]",
               "adminPassword":"[variables('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"[variables('imagePublisherWindows')]",
                  "offer":"[variables('imageOfferWindows')]",
                  "sku":"[variables('imageSKUWindows')]",
                  "version":"latest"
               },
               "osDisk":{
                  "name":"osdisk",
                  "vhd":{
                     "uri":"[concat('http://',variables('StorageAccountName'),'.blob.core.windows.net/vhds/gw-vm-osdisk.vhd')]"
                  },
                  "caching":"ReadWrite",
                  "createOption":"FromImage"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces','gw-nif')]"
                  }
               ]
            }
         },
         "resources":[
            {
               "apiVersion":"2015-05-01-preview",
               "type":"Microsoft.Compute/virtualMachines/extensions",
               "name":"gw-vm/GatewaySetup",
               "location":"[parameters('siteLocation')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Compute/virtualMachines', 'gw-vm')]"
               ],
               "properties":{
                  "publisher":"Microsoft.Powershell",
                  "type":"DSC",
                  "typeHandlerVersion":"2.8",
                  "settings":{
                     "ModulesUrl":"[concat(variables('customScriptLocation'),'Configuration.zip')]",
                     "ConfigurationFunction":"Configuration.ps1\\GatewaySetup",
                     "Properties":{
                        "DomainName":"[variables('domainName')]",
                        "AdminCreds":{
                           "UserName":"[variables('adminUsername')]",
                           "Password":"PrivateSettingsRef:AdminPassword"
                        },
                        "gridName":"[variables('ecGridname')]",
                        "LUS":"[concat('broker.',variables('domainName'))]",
                        "tenant":"root",
                        "externalfqdn":"[reference(variables('publicIpRef')).dnsSettings.fqdn]",
                        "emailAddress":"[parameters('emailAddress')]",
                        "softwareBaseLocation":"[variables('softwareBaseLocation')]"
                     }
                  },
                  "protectedSettings":{
                     "Items":{
                        "AdminPassword":"[variables('adminPassword')]"
                     }
                  }
               }
            }
         ]
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Compute/virtualMachines",
         "name":"[concat('rdsh-', copyindex())]",
         "location":"[parameters('siteLocation')]",
         "copy":{
            "name":"rdsh-vm-loop",
            "count":"[variables('numberOfRdshInstances')]"
         },
         "dependsOn":[
            "[concat('Microsoft.Storage/storageAccounts/', variables('StorageAccountName'))]",
            "[concat('Microsoft.Network/networkInterfaces/', 'rdsh-', copyindex(), '-nif')]"
         ],
         "properties":{
            "hardwareProfile":{
               "vmSize":"[variables('rdshVmSize')]"
            },
            "osProfile":{
               "computerName":"[concat('rdsh-', copyIndex())]",
               "adminUsername":"[variables('adminUsername')]",
               "adminPassword":"[variables('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"[variables('imagePublisherWindows')]",
                  "offer":"[variables('imageOfferWindows')]",
                  "sku":"[variables('imageSKUWindows')]",
                  "version":"latest"
               },
               "osDisk":{
                  "name":"osdisk",
                  "vhd":{
                     "uri":"[concat('http://',variables('StorageAccountName'),'.blob.core.windows.net/vhds/rdsh-',copyindex(),'-osdisk.vhd')]"
                  },
                  "caching":"ReadWrite",
                  "createOption":"FromImage"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces',concat('rdsh-', copyindex(), '-nif'))]"
                  }
               ]
            }
         },
         "resources":[
            {
               "apiVersion":"[variables('apiVersion')]",
               "type":"Microsoft.Compute/virtualMachines/extensions",
               "name":"[concat('rdsh-', copyindex(),'/ApplicationHost')]",
               "location":"[parameters('siteLocation')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Compute/virtualMachines', concat('rdsh-', copyindex()))]",
                  "Microsoft.Compute/virtualMachines/cb-vm/extensions/EricomConnectServerSetup"
               ],
               "properties":{
                  "publisher":"Microsoft.Powershell",
                  "type":"DSC",
                  "typeHandlerVersion":"2.8",
                  "settings":{
                     "ModulesUrl":"[concat(variables('customScriptLocation'),'Configuration.zip')]",
                     "ConfigurationFunction":"Configuration.ps1\\ApplicationHost",
                     "Properties":{
                        "DomainName":"[variables('domainName')]",
                        "AdminCreds":{
                           "UserName":"[variables('adminUsername')]",
                           "Password":"PrivateSettingsRef:AdminPassword"
                        },
                        "gridName":"[variables('ecGridname')]",
                        "LUS":"[concat('broker.',variables('domainName'))]",
                        "tenant":"root",
                        "softwareBaseLocation":"[variables('softwareBaseLocation')]"
                     }
                  },
                  "protectedSettings":{
                     "Items":{
                        "AdminPassword":"[variables('adminPassword')]"
                     }
                  }
               }
            }
         ]
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Compute/virtualMachines",
         "name":"cb-vm",
         "location":"[parameters('siteLocation')]",
         "dependsOn":[
            "[concat('Microsoft.Storage/storageAccounts/', variables('StorageAccountName'))]",
            "[resourceId('Microsoft.Compute/availabilitySets', 'availabilityset')]",
            "Microsoft.Network/networkInterfaces/cb-nif"
         ],
         "properties":{
            "hardwareProfile":{
               "vmSize":"Standard_D3"
            },
            "availabilitySet":{
               "id":"[resourceId('Microsoft.Compute/availabilitySets', 'availabilityset')]"
            },
            "osProfile":{
               "computerName":"broker",
               "adminUsername":"[variables('adminUsername')]",
               "adminPassword":"[variables('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"[variables('imagePublisherWindows')]",
                  "offer":"[variables('imageOfferWindows')]",
                  "sku":"[variables('imageSKUWindows')]",
                  "version":"latest"
               },
               "osDisk":{
                  "name":"osdisk",
                  "vhd":{
                     "uri":"[concat('http://',variables('StorageAccountName'),'.blob.core.windows.net/vhds/cb-vm-osdisk.vhd')]"
                  },
                  "caching":"ReadWrite",
                  "createOption":"FromImage"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces','cb-nif')]"
                  }
               ]
            }
         },
         "resources":[
            {
               "type":"Microsoft.Compute/virtualMachines/extensions",
               "name":"cb-vm/EricomConnectServerSetup",
               "apiVersion":"[variables('apiVersion')]",
               "location":"[parameters('siteLocation')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Compute/virtualMachines', 'cb-vm')]"
               ],
               "properties":{
                  "publisher":"Microsoft.Powershell",
                  "type":"DSC",
                  "typeHandlerVersion":"2.8",
                  "settings":{
                     "ModulesUrl":"[concat(variables('customScriptLocation'),'Configuration.zip')]",
                     "ConfigurationFunction":"Configuration.ps1\\EricomConnectServerSetup",
                     "Properties":{
                        "domainName":"[variables('domainName')]",
                        "adminCreds":{
                           "UserName":"[variables('adminUsername')]",
                           "Password":"PrivateSettingsRef:AdminPassword"
                        },
                        "externalfqdn":"[reference(variables('publicIpRef')).dnsSettings.fqdn]",
                        "gridName":"[variables('ecGridname')]",
                        "sqlserver":"[variables('sqlserver')]",
                        "sqldatabase":"[variables('sqldatabase')]",
                        "sqlCreds":{
                           "UserName":"[variables('sqluser')]",
                           "Password":"PrivateSettingsRef:SqlPassword"
                        },
                        "softwareBaseLocation":"[variables('softwareBaseLocation')]"
                     }
                  },
                  "protectedSettings":{
                     "Items":{
                        "AdminPassword":"[variables('adminPassword')]",
                        "SqlPassword":"[variables('sqlpassword')]"
                     }
                  }
               }
            }
         ]
      },
      {
         "apiVersion":"[variables('apiVersion')]",
         "type":"Microsoft.Compute/virtualMachines",
         "name":"[concat('lnx-', copyindex())]",
         "location":"[parameters('siteLocation')]",
         "copy":{
            "name":"lnx-vm-loop",
            "count":"[variables('numberOflnxInstances')]"
         },
         "dependsOn":[
            "[concat('Microsoft.Storage/storageAccounts/', variables('StorageAccountName'))]",
            "[concat('Microsoft.Network/networkInterfaces/', 'lnx-', copyindex(), '-nif')]"
         ],
         "properties":{
            "hardwareProfile":{
               "vmSize":"[variables('LinuxVmSize')]"
            },
            "osProfile":{
               "computerName":"[concat('lnx-', copyIndex())]",
               "adminUsername":"[variables('adminUsername')]",
               "adminPassword":"[variables('adminPassword')]"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"[variables('imagePublisherLinux')]",
                  "offer":"[variables('imageOfferLinux')]",
                  "sku":"[variables('imageSKULinux')]",
                  "version":"latest"
               },
               "osDisk":{
                  "name":"osdisk",
                  "vhd":{
                     "uri":"[concat('http://',variables('StorageAccountName'),'.blob.core.windows.net/vhds/lnx-',copyindex(),'-osdisk.vhd')]"
                  },
                  "caching":"ReadWrite",
                  "createOption":"FromImage"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces',concat('lnx-', copyindex(), '-nif'))]"
                  }
               ]
            }
         },
         "resources":[
            {
               "apiVersion":"[variables('apiVersion')]",
               "type":"Microsoft.Compute/virtualMachines/extensions",
               "name":"[concat('lnx-', copyindex(),'/script')]",
               "location":"[parameters('siteLocation')]",
               "dependsOn":[
                  "[resourceId('Microsoft.Compute/virtualMachines', concat('lnx-', copyindex()))]",
                  "Microsoft.Compute/virtualMachines/cb-vm/extensions/EricomConnectServerSetup"
               ],
               "properties":{
                  "publisher":"Microsoft.OSTCExtensions",
                  "type":"CustomScriptForLinux",
                  "typeHandlerVersion":"1.2",
                  "settings":{
                     "fileUris":[
                        "https://raw.githubusercontent.com/ErezPasternak/azure-quickstart-templates/EricomConnect/EricomConnect75/install_ericom.sh"
                     ],
                     "commandToExecute":"[concat(variables('command'), ' ' ,'lnx-', copyindex(),'.',variables('domainName'))]"
                  }
               }
            }
         ]
      }
   ]
}